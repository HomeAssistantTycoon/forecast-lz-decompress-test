name: Decompress BRRES LZ/LZ7 Files

on:
  workflow_dispatch:
    inputs:
      output_name:
        description: "Name for the output folder"
        required: false
        default: "output"

jobs:
  decompress:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install build dependencies
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake libjsoncpp-dev librhash-dev git

      # Step 3: Clone and build wit from source
      - name: Build wit from source
        run: |
          git clone https://github.com/Wiimm/wiimms-iso-tools.git /tmp/wiimms-iso-tools
          cd /tmp/wiimms-iso-tools
          make
          sudo cp wit /usr/local/bin/
          wit --version

      # Step 4: Create output folder
      - name: Create output folder
        run: mkdir -p "${{ github.event.inputs.output_name }}/brres"

      # Step 5: Decompress all .brres.lz / .brres.lz7 files (case-insensitive)
      - name: Decompress BRRES files
        run: |
          shopt -s nocaseglob
          for file in input/*.brres.*; do
            [ -f "$file" ] || continue
            ext="${file##*.}"
            if [[ "${ext,,}" != "lz" && "${ext,,}" != "lz7" ]]; then
              echo "Skipping $file (unsupported extension)"
              continue
            fi
            base=$(basename "$file")
            output="${{ github.event.inputs.output_name }}/brres/${base%.*}"
            mkdir -p "$(dirname "$output")"
            echo "Decompressing $file â†’ $output"
            wit lzdecompress "$file" "$output" || echo "Failed: $file"
          done
          echo "Final decompressed files:"
          ls -l "${{ github.event.inputs.output_name }}/brres/"

      # Step 6: Upload decompressed files as artifacts
      - name: Upload decompressed files
        uses: actions/upload-artifact@v4
        with:
          name: decompressed-brres
          path: ${{ github.event.inputs.output_name }}/brres/
