name: Decompress Nintendo Files

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Compression type to decompress"
        required: true
        default: "lz7"
        type: choice
        options:
          - lz7
          - yaz0
      output_name:
        description: "Name for the output folder"
        required: false
        default: "output"

jobs:
  decompress:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Wiimms SZS Tools
      - name: Install Wiimms SZS Tools
        run: |
          echo "Extracting Wiimms SZS Tools..."
          mkdir -p tools
          tar -xzf tools/szs-v2.42a-r8989-x86_64.tar.gz -C tools
          chmod +x tools/szs-v2.42a-r8989-x86_64/bin/*
          sudo cp tools/szs-v2.42a-r8989-x86_64/bin/* /usr/local/bin/
          echo "Installed Wiimms tools successfully."
          which wszst
          wszst --version

      # Step 3: Optional: Install Yaz0 decoder
      - name: Install Yaz0 decoder
        if: ${{ github.event.inputs.mode == 'yaz0' }}
        run: |
          echo "Installing Yaz0 decoder..."
          git clone https://github.com/SwareJonge/yaz0dec.git
          cd yaz0dec
          gcc yaz0dec.c -o yaz0dec
          sudo mv yaz0dec /usr/local/bin/
          echo "Yaz0dec installed successfully."
          which yaz0dec

      # Step 4: Decompress files
      - name: Run decompression
        run: |
          mkdir -p "${{ github.event.inputs.output_name }}"
          echo "Input files:"
          ls -l input/
          echo "Starting decompression..."
          for file in input/*; do
            echo "Processing $file..."
            if [ "${{ github.event.inputs.mode }}" == "yaz0" ]; then
              yaz0dec "$file" "${{ github.event.inputs.output_name }}/$(basename "$file").bin" || echo "Failed: $file"
            else
              # Explicit output filename to avoid silent failures
              wszst decompress "$file" -o "${{ github.event.inputs.output_name }}/$(basename "$file" .lz7)" || echo "Failed: $file"
            fi
          done
          echo "Decompression completed."

      # Step 5: Upload decompressed files
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: decompressed-files
          path: ${{ github.event.inputs.output_name }}/
