name: Decompress Nintendo RSO LZ7 Files

on:
  workflow_dispatch:
    inputs:
      output_name:
        description: "Name for the output folder"
        required: false
        default: "output"

jobs:
  decompress:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Download latest wit release (Linux x64)
      - name: Install latest wit
        run: |
          echo "Downloading latest wit..."
          wget -q https://github.com/WiiLink24/wit/releases/download/v2.11a/wit-v2.11a-linux.tar.xz -O /tmp/wit.tar.xz
          mkdir -p /tmp/wit
          tar -xf /tmp/wit.tar.xz -C /tmp/wit
          chmod +x /tmp/wit/wit
          sudo mv /tmp/wit/wit /usr/local/bin/
          wit --version

      # Step 3: Create output folder
      - name: Create output folder
        run: mkdir -p "${{ github.event.inputs.output_name }}/files"

      # Step 4: Decompress all .rso.lz7 files in input/
      - name: Decompress RSO LZ7 files
        run: |
          echo "Listing input folder contents:"
          ls -l input/
          echo "Starting decompression..."
          for file in input/*.rso.lz7; do
            if [ ! -f "$file" ]; then
              echo "No .rso.lz7 files found, skipping."
              continue
            fi
            TEMP_FILE="${file%.lz7}"   # Strip .lz7 extension temporarily
            cp "$file" "$TEMP_FILE"
            echo "Decompressing $TEMP_FILE â†’ ${{ github.event.inputs.output_name }}/files/"
            /usr/local/bin/wit extract "$TEMP_FILE" --dest "${{ github.event.inputs.output_name }}/files/" || echo "Failed to extract $file"
            rm "$TEMP_FILE"
          done
          echo "Final decompressed files:"
          find "${{ github.event.inputs.output_name }}/files/" -type f
          echo "Decompression completed."

      # Step 5: Upload decompressed files as artifacts
      - name: Upload decompressed files
        uses: actions/upload-artifact@v4
        with:
          name: decompressed-files
          path: ${{ github.event.inputs.output_name }}/files/
