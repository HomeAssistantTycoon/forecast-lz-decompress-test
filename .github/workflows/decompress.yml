name: Decompress BRRES Workflow
on: [push]

jobs:
  decompress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Wiimm SZS Tools
        run: |
          # Download and extract the latest Wiimms SZS Tools (Linux x64)
          wget -O szs-tools.tar.gz https://szs.wiimm.de/download/szs-v2.42a-r8989-x86_64.tar.gz
          tar -xzf szs-tools.tar.gz
          # Add the toolâ€™s bin directory to PATH for subsequent steps
          SZS_DIR=$(find . -maxdepth 1 -type d -name "szs-*" -print -quit)
          echo "$PWD/$SZS_DIR/bin" >> $GITHUB_PATH

      - name: Decompress .brres.lz and .brres.lz7 files
        run: |
          # Enable recursive globbing and case-insensitive matching
          shopt -s globstar nocaseglob
          for file in **/*.brres.lz*; do
            [ -f "$file" ] || continue
            # Compute output path by removing the last extension (e.g., .lz or .lz7)
            out="${file%.*}"
            mkdir -p "$(dirname "$out")"
            # Decompress into the .brres file (output argument, not using -o)
            wszst decompress "$file" "$out"
          done

      - name: Upload decompressed .brres files
        uses: actions/upload-artifact@v4
        with:
          name: decompressed-brres
          path: |
            **/*.brres
